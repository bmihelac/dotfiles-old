"flake8
autocmd FileType python map <buffer> <M-F7> :call Flake8()<CR>

call pathogen#runtime_append_all_bundles() 
call pathogen#helptags()

source ~/.vim/vimrc
source ~/.vim/activate_django.vim

"Map leader to ,
let mapleader = ","

" keys in terminal
set <S-F5>=[18~
map <S-F5> :NERDTreeToggle<CR>


map <F3> :NERDTreeToggle<CR>
map <F4> :TlistToggle<CR>
nnoremap <F2> :set invpaste paste?<CR>

:set guioptions-=T  "remove toolbar
:set guioptions-=m  "remove menubar

" Change to directory of the opened file
command! CD cd %:p:h

" Activate the snippets
autocmd FileType python set ft=python.django " For SnipMate
autocmd FileType html set ft=htmldjango.html " For SnipMate
autocmd FileType xhtml set ft=htmldjango.html " For SnipMate

" Tidy
"setlocal makeprg=tidy\ -quiet\ -errors\ %
"setlocal errorformat=line\ %l\ column\ %v\ -\ %m

" for CSS, also have things in braces indented:
autocmd FileType css set smartindent
" for HTML, generally format text, but if a long line has been created
" leave it alone when editing:
autocmd FileType html set formatoptions+=tl
" for both CSS and HTML, use genuine tab characters for 
" indentation, to make files a few bytes smaller:
autocmd FileType html,htmldjango set et sw=2 sts=2 ts=2
autocmd FileType python set ai ts=4 sts=4 et sw=4
autocmd FileType javascript,scss,css,less.css set ai et ts=2 sts=2 sw=2
autocmd BufNewFile,BufRead *.jst.ejs set filetype=html

"Let zen-coding and less work together
autocmd FileType less set ft=less.css

" line numbers
:nmap <F9> :set invnumber<CR>

" ignore
:set wildignore=*.o,*~,*.pyc

" command-t
map <C-F> :CommandT<CR>
map <C-F6> :CommandTFlush<CR>
let g:fuzzy_ignore="*.pyc,*~,tmp/*"
set wildignore+=*.jpg,*.gif,*.png,*.pdf

"NerdTREE mapings
:map <F5> :NERDTreeFind<CR>

" Auto reload changed files
:set autoread

" map enter to add new line below current staying in normal mode 
map <Enter> o<Esc>
map <S-Enter> o<Esc>

" smart ignorecase
:set smartcase

" map cmd-] and cmd-[ to next/prev tab
" TODO: test in ubuntu
nmap <D-[> gT
nmap <D-]> gt
map <D-1> 1gt
map <D-2> 2gt
map <D-3> 3gt
map <D-4> 4gt
map <D-5> 5gt
map <D-6> 6gt
map <D-7> 7gt
map <D-8> 8gt
map <D-9> 9gt
map <silent><A-Right> :tabnext<CR> 
map <silent><A-Left> :tabprevious<CR> 

"toggle search options
:map <D-F5> :set invincsearch<CR>
:nmap <silent> ,/ :nohlsearch<CR>

nnoremap <Leader>t :tabnew<CR>
nnoremap <Leader>tc :tabclose<CR>
nnoremap <Leader>to :tabonly<CR>
nnoremap <Leader>1 1gt
nnoremap <Leader>2 2gt
nnoremap <Leader>3 3gt
nnoremap <Leader>4 4gt
nnoremap <Leader>5 5gt
nnoremap <Leader>6 6gt
nnoremap <Leader>7 7gt
nnoremap <Leader>8 8gt
nnoremap <Leader>9 9gt

nnoremap <Leader>,m :set mouse-=a
nnoremap <Leader>,M :set mouse+=a
"
"copy current file name to register
:nmap <Leader>f :let @+ = expand('%:t')<CR>
:nmap <Leader>F :let @+ = expand('%:p')<CR>

" Scroll the viewport faster
nnoremap <C-e> 3<C-e>
nnoremap <C-y> 3<C-y>

set visualbell           " don't beep
set noerrorbells         " don't beep

" Use Q for formatting the current paragraph (or selection)
vmap Q gq
nmap Q gqap

" Easy window navigation
map <C-h> <C-w>h
map <C-j> <C-w>j
map <C-k> <C-w>k
map <C-l> <C-w>l

" disable backups
set nobackup
set noswapfile

" highlights the background in a subtle red for text that goes over the 80
set cc=80

"yankring
:nnoremap <silent> <F10> :YRShow<CR>

" replace the current word with the last yanked text
nnoremap S "_diwP

" rest headings
let @q='yypVr='
let @w='yypVr-'
let @e='yypVr^'

" Python tools
let ropevim_vim_completion=1
let ropevim_extended_complete=1
let ropevim_guess_project=1
let ropevim_enable_autoimport=1
let g:ropevim_autoimport_modules = ["os", "shutil", 'django.*']
imap <F12> <M-/>
map <C-F12> :RopeAutoImport<CR>
map <C-S-A-F12> :RopeGenerateAutoimportCache<CR>


map <silent> <F12> :let @+=@"<CR>

" Run the current buffer as Python code
fu! DoRunPyBuffer2()
    pclose! " force preview window closed
    setlocal ft=python

    " copy the buffer into a new window, then run that buffer through python
    sil %y a | below new | sil put a | sil %!python -
    " indicate the output window as the current previewwindow
    setlocal previewwindow ro nomodifiable nomodified

    " back into the original window
    winc p
endfu

command! RunPyBuffer call DoRunPyBuffer2()
map <Leader>p :RunPyBuffer<CR>
nnoremap <Leader>pd :RopeShowDoc<CR>

" sudo & write
cmap w!! w !sudo tee % >/dev/null

" MacVim
if has("gui_macvim")
    set guifont=Monaco\ for\ Powerline:h12
    "set guifont=Inconsola
endif

colorscheme wombat256mod

"django mappings from http://code.djangoproject.com/wiki/UsingVimWithDjango#no1
let g:last_relative_dir = ''
nnoremap \1 :call RelatedFile ("models.py")<cr>
nnoremap \2 :call RelatedFile ("views.py")<cr>
nnoremap \3 :call RelatedFile ("urls.py")<cr>
nnoremap \4 :call RelatedFile ("admin.py")<cr>
nnoremap \5 :call RelatedFile ("tests.py")<cr>
nnoremap \6 :call RelatedFile ( "templates/" )<cr>
nnoremap \7 :call RelatedFile ( "templatetags/" )<cr>
nnoremap \8 :call RelatedFile ( "management/" )<cr>
nnoremap \0 :e settings.py<cr>
nnoremap \9 :e urls.py<cr>

fun! RelatedFile(file)
    "This is to check that the directory looks djangoish
    if filereadable(expand("%:h"). '/models.py') || isdirectory(expand("%:h") . "/templatetags/")
        exec "edit %:h/" . a:file
        let g:last_relative_dir = expand("%:h") . '/'
        return ''
    endif
    if g:last_relative_dir != ''
        exec "edit " . g:last_relative_dir . a:file
        return ''
    endif
    echo "Cant determine where relative file is : " . a:file
    return ''
endfun

fun SetAppDir()
    if filereadable(expand("%:h"). '/models.py') || isdirectory(expand("%:h") . "/templatetags/")
        let g:last_relative_dir = expand("%:h") . '/'
        return ''
    endif
endfun
autocmd BufEnter *.py call SetAppDir()

" really remove
nnoremap R "_d

" http://vim.wikia.com/wiki/Diff_current_buffer_and_the_original_file
function! s:DiffWithSaved()
  let filetype=&ft
  diffthis
  vnew | r # | normal! 1Gdd
  diffthis
  exe "setlocal bt=nofile bh=wipe nobl noswf ro ft=" . filetype
endfunction
com! DiffSaved call s:DiffWithSaved()

" django test runner
"map <leader>dt :set makeprg=python\ manage.py\ test\|:call MakeGreen()<CR>

" edit my vimrc
:nnoremap <Leader>ev :vsplit $MYVIMRC<CR>
:nnoremap <Leader>sv :so $MYVIMRC<CR>

" ack
:nnoremap <leader>a <Esc>:Ack! 

"
" swap 2 params in visual selection
" ie: fun(a(), b()) => fun(b(), a())
:vnoremap <Leader>s :s/\%V\([^,]\+\)\(, *\)\(.*\%V.\)/\3\2\1<CR>gv<Esc>:noh<CR>

:nnoremap <Leader>sw :Git add .<CR>:Git commit -a -m "edited via VIM"<CR>:Git push<CR>

" Write contents of register to remote file
:nnoremap <leader>xc :new<CR>P:w scp://localhost/clipboard.txt<CR><CR>:bd<CR>

"quote every line in single quotes, add comma at the end, and reformat block
:vnoremap <Leader>q' :s/\(.*\)/'\1',/g<CR>gv=:nohlsearch<CR>

" tidy html
:vnoremap <Leader>T :!tidy -q -i -xml<CR>

" always vertical split in diff
:set diffopt+=vertical

"vim-powerline
let g:Powerline_symbols = 'fancy'

"zen-coding
let g:user_zen_settings = { 'indentation' : ' ' }

"syntastic
let g:syntastic_mode_map = { 'mode': 'active',
                             \ 'active_filetypes': ['ruby', 'python'],
                             \ 'passive_filetypes': ['html'] }"


"convert trailing tabs to 2 spaces
:nnoremap <Leader>ts :%s/\t/  /g<CR>

"remove whitespace at end of lines
:nnoremap <Leader>rs :%s/\s\+$//g<CR>

" fugitive shortcuts
" push
:nnoremap <Leader>gps :Git push<CR>
" commit current file
:nnoremap <Leader>gc :Git commit % -m ""<left>
" diff current file
:nnoremap <Leader>gd :Gdiff<CR>
" status
:nnoremap <Leader>gs :Gstatus<CR>

"html helpers
"wrap selection in a link
:vmap <Leader>wa S<a href="#">

"xml helpers
"convert '<ID>20000608012</ID>'  to 'ID=20000608012,' on current line
:nnoremap <Leader>xx :s/<\(\w\+\)>\([^<]\+\)<[^>]\+>/\1='\2',/g
